name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint (golangci-lint)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true
      - name: GolangCI-Lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest
          args: --timeout=5m

  vet:
    name: go vet
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true
      - name: Vet
        run: go vet ./...

  test:
    name: Tests (race + coverage)
    runs-on: ubuntu-latest
    needs: vet
    steps:
      - uses: actions/checkout@v4
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true
      - name: Download modules
        run: go mod download
      - name: Run tests
        run: |
          go test -race -coverprofile=coverage.out -covermode=atomic ./...
      - name: Show coverage summary
        run: go tool cover -func=coverage.out | tail -n 1
      - name: Enforce coverage threshold (>= 80%)
        run: |
          THRESHOLD=80
          TOTAL=$(go tool cover -func=coverage.out | awk '/total:/ {gsub("%","",$3); print $3}')
          awk -v total="$TOTAL" -v thr="$THRESHOLD" 'BEGIN{ if (total+0 < thr+0) { printf "Coverage %.2f%% below threshold %.2f%%\n", total, thr; exit 1 } else { printf "Coverage %.2f%% meets threshold %.2f%%\n", total, thr } }'
      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage.out
          path: coverage.out

  security:
    name: Security (gosec)
    runs-on: ubuntu-latest
    needs: test
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true
      - name: Install gosec
        run: go install github.com/securego/gosec/v2/cmd/gosec@latest
      - name: Run gosec (SARIF)
        run: |
          $(go env GOPATH)/bin/gosec -no-fail -fmt=sarif -out=gosec.sarif ./...
      - name: Upload SARIF (gosec)
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: gosec.sarif

  build-image:
    name: Build & Push Docker Image (GHCR)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    needs: security
    permissions:
      contents: read
      packages: write
      security-events: write
    steps:
      - uses: actions/checkout@v4
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build and push
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/financialsystempro:${{ github.sha }}
            ghcr.io/${{ github.repository_owner }}/financialsystempro:ci-latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      - name: Image digest
        run: echo IMAGE_DIGEST=${{ steps.build.outputs.digest }}
      - name: Install Trivy
        run: |
          sudo apt-get update -y
          sudo apt-get install -y curl jq
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b ./trivy
          ./trivy --version
      - name: Trivy FS scan
        run: |
          ./trivy filesystem --ignore-unfixed --format sarif --output trivy-fs.sarif . || true
      - name: Upload SARIF (Trivy FS)
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-fs.sarif
      - name: Trivy Image scan
        run: |
          ./trivy image --ignore-unfixed --format sarif --output trivy-image.sarif ghcr.io/${{ github.repository_owner }}/financialsystempro:${{ github.sha }} || true
      - name: Upload SARIF (Trivy Image)
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-image.sarif
      - name: Trivy FS scan (JSON for gating)
        run: |
          ./trivy filesystem --ignore-unfixed --severity HIGH,CRITICAL --format json --output trivy-fs.json . || true
      - name: Trivy Image scan (JSON for gating)
        run: |
          ./trivy image --ignore-unfixed --severity HIGH,CRITICAL --format json --output trivy-image.json ghcr.io/${{ github.repository_owner }}/financialsystempro:${{ github.sha }} || true
      - name: Fail on HIGH/CRITICAL vulnerabilities
        env:
          ALLOW_VULN: false
        run: |
          jq -s '[.[].Results[].Vulnerabilities[]?]' trivy-fs.json trivy-image.json > combined.json
          HIGH=$(jq '[.[] | select(.Severity=="HIGH")] | length' combined.json)
          CRIT=$(jq '[.[] | select(.Severity=="CRITICAL")] | length' combined.json)
          echo "HIGH vulnerabilities: $HIGH"
          echo "CRITICAL vulnerabilities: $CRIT"
          if [ "$ALLOW_VULN" = "true" ]; then
            echo "ALLOW_VULN=true -> não falhando apesar das vulnerabilidades."; exit 0;
          fi
          if [ $HIGH -gt 0 ] || [ $CRIT -gt 0 ]; then
            echo "❌ Encontradas vulnerabilidades HIGH($HIGH) ou CRITICAL($CRIT). Falhando pipeline."; exit 1;
          else
            echo "✅ Nenhuma vulnerabilidade HIGH/CRITICAL encontrada.";
          fi

  coverage-report:
    name: Upload Coverage to Codecov
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true
      - name: Download coverage artifact
        uses: actions/download-artifact@v4
        with:
          name: coverage.out
          path: .
      - name: Upload to Codecov (public repos no token)
        uses: codecov/codecov-action@v4
        with:
          files: coverage.out
          flags: unittests
          fail_ci_if_error: false

# Extensões futuras sugeridas (já incluímos algumas):
# - CodeQL (workflow separado)
# - Codecov (job coverage-report)
# - Trivy (FS + Image scans)
# - Gosec com SARIF
# Futuro: Dependabot, Snyk (alternativa proprietária), OSV scanner
