name: CD

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

concurrency:
  group: cd-${{ github.ref }}
  cancel-in-progress: true

jobs:
  release-image:
    name: Build & Push Release Image
    runs-on: ubuntu-latest
    # environment: production  # Uncomment after creating environment in repo settings
    permissions:
      contents: read
      packages: write
      security-events: write
    steps:
      - uses: actions/checkout@v4
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build and push multi-arch image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ghcr.io/${{ github.repository_owner }}/financialsystempro:${{ github.ref_name }}
            ghcr.io/${{ github.repository_owner }}/financialsystempro:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      - name: Show digest
        run: echo RELEASE_DIGEST=${{ steps.build.outputs.digest }}
      - name: Install Trivy
        run: |
          sudo apt-get update -y
          sudo apt-get install -y curl jq
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b ./trivy
          ./trivy --version
      - name: Trivy Image scan (SARIF)
        run: |
          ./trivy image --ignore-unfixed --format sarif --output trivy-image.sarif ghcr.io/${{ github.repository_owner }}/financialsystempro:${{ github.ref_name }} || true
      - name: Upload SARIF (Trivy Image)
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-image.sarif
      - name: Trivy Image scan (JSON for gating)
        run: |
          ./trivy image --ignore-unfixed --severity HIGH,CRITICAL --format json --output trivy-image.json ghcr.io/${{ github.repository_owner }}/financialsystempro:${{ github.ref_name }} || true
      - name: Fail on HIGH/CRITICAL vulnerabilities
        env:
          ALLOW_VULN: false
        run: |
          jq '[.Results[].Vulnerabilities[]?]' trivy-image.json > vulns.json
          HIGH=$(jq '[.[] | select(.Severity=="HIGH")] | length' vulns.json)
          CRIT=$(jq '[.[] | select(.Severity=="CRITICAL")] | length' vulns.json)
          echo "HIGH vulnerabilities: $HIGH"
          echo "CRITICAL vulnerabilities: $CRIT"
          if [ "$ALLOW_VULN" = "true" ]; then
            echo "ALLOW_VULN=true -> não falhando apesar das vulnerabilidades."; exit 0;
          fi
          if [ $HIGH -gt 0 ] || [ $CRIT -gt 0 ]; then
            echo "❌ Encontradas vulnerabilidades HIGH($HIGH) ou CRITICAL($CRIT). Falhando pipeline."; exit 1;
          else
            echo "✅ Nenhuma vulnerabilidade HIGH/CRITICAL encontrada.";
          fi

  # Opcional: Deploy usando Railway (requer secret RAILWAY_TOKEN)
  # railway-deploy:
  #   name: Railway Deploy
  #   runs-on: ubuntu-latest
  #   needs: release-image
  #   if: github.event_name == 'push'
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Install Railway CLI
  #       run: curl -fsSL https://railway.app/install.sh | sh
  #     - name: Login Railway
  #       run: railway login --token ${{ secrets.RAILWAY_TOKEN }}
  #     - name: Trigger deploy
  #       run: railway up --service financialsystempro

# Para habilitar o deploy, crie o secret RAILWAY_TOKEN em Settings > Secrets > Actions.
# Outras integrações possíveis:
# - Publicar release no GitHub (actions/create-release)
# - Scanner de vulnerabilidades (aquasecurity/trivy-action)
